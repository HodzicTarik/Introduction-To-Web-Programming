/*! jQuery SPA Plugin | (c) 2019 Milan Jovanovic | License: MIT */
(function($) {
    $.spapp = function(config) {
        var app = this;
        app.config = $.extend({
            defaultView: $("main#spapp > section:first-child").attr("id"),
            templateDir: "",
            pageNotFound: false
        }, config);

        app.routes = {};

        $("main#spapp > section").each(function() {
            var elm = $(this);
            app.routes[elm.attr("id")] = {
                view: elm.attr("id"),
                load: elm.data("load"),
                onCreate: function() {},
                onReady: function() {}
            };
        });

        app.route = function(options) {
            $.extend(app.routes[options.view], options);
        };

        app.load = function(id) {
            var route = app.routes[id];
            var elm = $("#" + id);

            if (!route) {
                if (app.config.pageNotFound) {
                    return app.load(app.config.pageNotFound);
                }
                console.warn("Route not found:", id);
                return;
            }

            // Sakrij sve sekcije osim aktivne
            $("main#spapp > section").hide();

            // Ako je home stranica, samo prikaži (ne briši sadržaj)
            if (id === "home") {
                elm.show();
                route.onReady();
                return;
            }

            let cachedContent = sessionStorage.getItem(id);
            if (cachedContent) {
                elm.html(cachedContent).show();
                route.onReady();
            } else {
                if (!route.load) {
                    route.onCreate();
                    route.onReady();
                } else {
                    elm.load(app.config.templateDir + route.load, function() {
                        sessionStorage.setItem(id, elm.html());
                        route.onCreate();
                        route.onReady();
                    }).show();
                }
            }
        };

        app.run = function() {
            $(window).on("hashchange", function() {
                app.load(location.hash.slice(1) || app.config.defaultView);
            });

            app.load(location.hash.slice(1) || app.config.defaultView);
        };

        return app;
    };
})(jQuery);
